# ESLint + TypeScript Monorepo 配置指南

> 本文基于 ESLint v9 Flat Config + TypeScript ESLint v8 Project Service API，结合 Turborepo 最佳实践编写。

## 目录

- [设计理念](#设计理念)
- [目录结构](#目录结构)
- [共享配置包](#共享配置包)
- [TypeScript 配置体系](#typescript-配置体系)
- [类型感知 Linting](#类型感知-linting)
- [子项目配置](#子项目配置)
- [性能优化](#性能优化)
- [常见问题](#常见问题)

---

## 设计理念

### 核心原则

在 Monorepo 中配置 ESLint 和 TypeScript，需要遵循以下核心原则：

| 原则         | 说明                                      |
| ------------ | ----------------------------------------- |
| **配置复用** | 共享配置包集中管理规则，避免重复          |
| **依赖集中** | ESLint 相关依赖放在共享包中，减少版本冲突 |
| **灵活扩展** | 子项目可以继承并扩展共享配置              |
| **缓存友好** | 配置结构有利于提高缓存命中率              |

### ESLint Flat Config 的优势

ESLint v9 引入的 Flat Config 特别适合 Monorepo：

```javascript
// 传统配置（.eslintrc.js）- 需要复杂的 extends 链
module.exports = {
  extends: ['plugin:vue/vue3-recommended', '@vue/typescript/recommended'],
  // ...
}

// Flat Config（eslint.config.js）- 直接组合配置数组
export default [
  ...baseConfig,
  ...vueConfig,
  {
    rules: {
      /* 自定义规则 */
    },
  },
]
```

### 共享配置的骨架-成员模型

参考 [Felipe Morais 的文章](https://medium.com/@felipeprodev/how-to-use-eslint-v9-in-a-monorepo-with-flat-config-file-format-8ef2e06ce296)，可以将配置理解为：

- **骨架（Skeleton）**：Monorepo 的基础结构
- **成员（Members）**：各个 Shareable Config（如 base、vue3、typescript）
- **身体（Body）**：组合成员形成的完整规则集

```
┌─────────────────────────────────────────┐
│              Rule Set (Body)            │
│  ┌─────────┬─────────┬─────────┐        │
│  │  base   │  vue3   │ custom  │        │
│  │ config  │ config  │  rules  │        │
│  └────┬────┴────┬────┴────┬────┘        │
│       │         │         │             │
│       └─────────┼─────────┘             │
│                 ▼                       │
│         Combined Config                 │
└─────────────────────────────────────────┘
```

---

## 目录结构

### 推荐的 Monorepo 结构

```
monorepo/
├── apps/                          # 应用目录
│   ├── vue3-app/
│   │   ├── src/
│   │   ├── eslint.config.js       # 应用特定配置
│   │   ├── tsconfig.json          # 引用 app 和 node 配置
│   │   ├── tsconfig.app.json      # 应用代码配置
│   │   └── tsconfig.node.json     # 构建工具配置
│   └── api-server/
│       ├── src/
│       ├── eslint.config.js
│       └── tsconfig.json
│
├── packages/                      # 共享包目录
│   ├── eslint-config/             # ⭐ 共享 ESLint 配置
│   │   ├── src/
│   │   │   ├── index.ts           # 统一导出
│   │   │   ├── base.ts            # 基础配置
│   │   │   ├── typescript.ts      # TypeScript 规则
│   │   │   ├── vue3.ts            # Vue3 规则
│   │   │   ├── prettier.ts        # Prettier 集成
│   │   │   └── ignores.ts         # 全局忽略
│   │   ├── package.json
│   │   └── tsconfig.json
│   └── utils/
│       └── ...
│
├── eslint.config.js               # 根目录配置（仅 lint 根目录文件）
├── tsconfig.json                  # 根 tsconfig
├── tsconfig.base.json             # 基础编译选项
├── tsconfig.lib.json              # 库包配置模板
├── tsconfig.node.base.json        # Node.js 环境配置
└── package.json
```

### ESLint 配置查找机制

ESLint 从被 lint 的文件目录开始，向上查找 `eslint.config.js`：

```
/monorepo/apps/vue3-app/src/components/Button.vue
                    ↑
查找顺序：
1. /monorepo/apps/vue3-app/src/components/eslint.config.js ❌
2. /monorepo/apps/vue3-app/src/eslint.config.js ❌
3. /monorepo/apps/vue3-app/eslint.config.js ✅ 找到！使用此配置
```

这意味着：

- **根目录配置**：作为所有项目的默认配置
- **子项目配置**：覆盖根配置，用于特定需求（如 Vue、React）

---

## 共享配置包

### package.json 配置

```json
{
  "name": "@breeze/eslint-config",
  "version": "1.0.0",
  "type": "module",
  "exports": {
    ".": "./src/index.ts",
    "./base": "./src/base.ts",
    "./vue3": "./src/vue3.ts",
    "./typescript": "./src/typescript.ts",
    "./prettier": "./src/prettier.ts",
    "./ignores": "./src/ignores.ts"
  },
  "dependencies": {
    "@eslint/js": "^9.39.2",
    "@vue/eslint-config-typescript": "^14.6.0",
    "eslint-config-prettier": "^10.1.8",
    "eslint-plugin-prettier": "^5.5.4",
    "eslint-plugin-vue": "^10.5.1",
    "typescript-eslint": "^8.49.0"
  },
  "peerDependencies": {
    "eslint": "^9.0.0",
    "prettier": "^3.0.0",
    "typescript": ">=5.0.0"
  }
}
```

**关键点：**

- ESLint 插件放在 `dependencies` 而非 `peerDependencies`
- 多入口导出支持按需引用
- `eslint`、`prettier`、`typescript` 作为 peer 依赖

### 基础配置 (base.ts)

```typescript
import type { Linter } from 'eslint'
import eslint from '@eslint/js'
import { ignores } from './ignores.ts'
import { prettier } from './prettier.ts'
import { typescript } from './typescript.ts'

export const base: Linter.Config[] = [
  // 全局忽略规则
  ignores,

  // ESLint 推荐规则
  eslint.configs.recommended,

  // TypeScript 规则（包含类型感知）
  ...typescript,

  // Prettier 集成（放最后以覆盖冲突规则）
  ...prettier,
]
```

### TypeScript 配置 (typescript.ts)

```typescript
import type { Linter } from 'eslint'
import tseslint from 'typescript-eslint'

export const typescript: Linter.Config[] = [
  // TypeScript 推荐规则
  ...tseslint.configs.recommended,

  {
    name: '@breeze/typescript/typed-linting',
    languageOptions: {
      parserOptions: {
        // Project Service API（v8+ 推荐）
        projectService: {
          // 允许不在 tsconfig 中的文件（如配置文件）
          allowDefaultProject: ['*.js', '*.mjs', '*.cjs'],
        },
      },
    },
    rules: {
      // Promise 相关规则
      '@typescript-eslint/no-floating-promises': 'error',
      '@typescript-eslint/await-thenable': 'error',
      '@typescript-eslint/no-misused-promises': 'error',

      // 类型完整性检查
      '@typescript-eslint/switch-exhaustiveness-check': 'error',

      // 类型安全规则（警告级别）
      '@typescript-eslint/no-unnecessary-condition': 'warn',
      '@typescript-eslint/no-unnecessary-type-assertion': 'warn',

      // 放宽 no-unused-vars（支持 _ 前缀）
      '@typescript-eslint/no-unused-vars': [
        'warn',
        { argsIgnorePattern: '^_', varsIgnorePattern: '^_' },
      ],
    },
  },
]
```

### Vue3 配置 (vue3.ts)

```typescript
import { vueTsConfigs } from '@vue/eslint-config-typescript'
import pluginVue from 'eslint-plugin-vue'
import { base } from './base.ts'

export const vue3 = [
  // 基础配置
  ...base,

  // Vue 文件范围
  {
    name: '@breeze/vue3/files-to-lint',
    files: ['**/*.{ts,mts,tsx,vue}'],
  },

  // Vue 推荐规则
  pluginVue.configs['flat/recommended'],

  // Vue + TypeScript 集成
  vueTsConfigs.recommended,

  // 关闭与 Prettier 冲突的规则
  {
    name: '@breeze/vue3/prettier-compat',
    rules: {
      'vue/singleline-html-element-content-newline': 'off',
      'vue/multiline-html-element-content-newline': 'off',
      'vue/html-self-closing': 'off',
      'vue/html-indent': 'off',
      'vue/max-attributes-per-line': 'off',
      'vue/first-attribute-linebreak': 'off',
      'vue/html-closing-bracket-newline': 'off',
    },
  },
]
```

### 全局忽略 (ignores.ts)

```typescript
import { globalIgnores } from 'eslint/config'

export const ignores = globalIgnores([
  // 依赖目录
  '**/node_modules/**',

  // 构建输出
  '**/dist/**',
  '**/build/**',
  '**/out/**',
  '**/.output/**',

  // 框架特定
  '**/.next/**',
  '**/.nuxt/**',
  '**/.turbo/**',

  // 缓存
  '**/.cache/**',
  '**/coverage/**',

  // 类型声明（自动生成）
  '**/*.d.ts',
  '!**/src/**/*.d.ts',

  // 锁文件
  '**/pnpm-lock.yaml',
  '**/package-lock.json',
  '**/yarn.lock',
])
```

---

## TypeScript 配置体系

### 分层配置结构

```
tsconfig.json (根配置)
    │
    ├── tsconfig.base.json (基础编译选项)
    │       │
    │       ├── tsconfig.lib.json (库包模板)
    │       │       └── packages/*/tsconfig.json
    │       │
    │       └── apps/*/tsconfig.app.json
    │
    └── tsconfig.node.base.json (Node.js 环境)
            └── apps/*/tsconfig.node.json
```

### tsconfig.base.json

```json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "compilerOptions": {
    "target": "ESNext",
    "lib": ["ES2020"],
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true,
    "isolatedModules": true,
    "strict": true,
    "skipLibCheck": true
  }
}
```

### tsconfig.lib.json（库包模板）

```json
{
  "extends": "./tsconfig.base.json",
  "compilerOptions": {
    "composite": true,
    "incremental": true,
    "declaration": true,
    "declarationMap": true,
    "emitDeclarationOnly": true,
    "noEmitOnError": true
  }
}
```

### tsconfig.node.base.json（Node.js 环境）

```json
{
  "extends": "@tsconfig/node24/tsconfig.json",
  "compilerOptions": {
    "noEmit": true,
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "types": ["node"]
  }
}
```

### 应用项目配置示例

**tsconfig.json（入口）**

```json
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
```

**tsconfig.app.json（应用代码）**

```json
{
  "extends": ["../../tsconfig.base.json", "@vue/tsconfig/tsconfig.dom.json"],
  "include": ["env.d.ts", "src/**/*", "src/**/*.vue"],
  "compilerOptions": {
    "composite": true,
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

**tsconfig.node.json（构建工具）**

```json
{
  "extends": "../../tsconfig.node.base.json",
  "include": ["vite.config.*", "tailwind.config.*", "eslint.config.*"],
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo"
  }
}
```

---

## 类型感知 Linting

### Project Service API vs parserOptions.project

| 特性           | Project Service (推荐) | parserOptions.project |
| -------------- | ---------------------- | --------------------- |
| 配置复杂度     | 零配置                 | 需要手动指定路径      |
| Monorepo 支持  | 自动发现               | 需要配置 glob         |
| .vue 文件支持  | 原生支持               | 需要额外配置          |
| ESLint --fix   | 不丢失类型信息         | 可能丢失类型信息      |
| 与编辑器一致性 | 使用相同逻辑           | 可能不一致            |

### 启用 Project Service

```typescript
{
  languageOptions: {
    parserOptions: {
      projectService: {
        // 允许不在 tsconfig 中的 JS 配置文件
        allowDefaultProject: ['*.js', '*.mjs', '*.cjs'],
      },
    },
  },
}
```

### 处理 "file not found by project service" 错误

当遇到此错误时，有两种解决方案：

**方案 1：将文件添加到 tsconfig 的 include 中**

```json
// tsconfig.node.json
{
  "include": ["vite.config.*", "tailwind.config.*", "eslint.config.*"]
}
```

**方案 2：使用 allowDefaultProject（推荐用于 JS 配置文件）**

```typescript
projectService: {
  allowDefaultProject: ['*.js', '*.mjs', '*.cjs'],
}
```

---

## 子项目配置

### 根目录配置

```javascript
// /monorepo/eslint.config.js
import { base } from '@breeze/eslint-config'

export default [
  ...base,
  {
    // 只 lint 根目录文件，子项目使用各自配置
    ignores: ['apps/**', 'packages/**'],
  },
]
```

### Vue3 应用配置

```javascript
// /monorepo/apps/vue3-app/eslint.config.js
import { defineConfigWithVueTs } from '@vue/eslint-config-typescript'
import { vue3 } from '@breeze/eslint-config'
import autoImportGlobals from './.eslintrc-auto-import.json' with { type: 'json' }

export default defineConfigWithVueTs(
  // 共享的 Vue3 配置
  ...vue3,

  // 项目特定配置
  {
    name: 'vue3-app/auto-import',
    languageOptions: {
      globals: autoImportGlobals.globals,
    },
  },

  // 自定义规则（可选）
  // {
  //   name: 'vue3-app/custom-rules',
  //   rules: {},
  // },
)
```

### Node.js 项目配置

```javascript
// /monorepo/apps/api-server/eslint.config.js
import { base } from '@breeze/eslint-config'

export default [
  ...base,
  {
    name: 'api-server/node-globals',
    languageOptions: {
      globals: {
        process: 'readonly',
        __dirname: 'readonly',
        __filename: 'readonly',
      },
    },
  },
]
```

---

## 性能优化

### 1. 启用 ESLint 缓存

```json
{
  "scripts": {
    "lint": "eslint . --cache --cache-location .eslintcache",
    "lint:fix": "eslint . --fix --cache --cache-location .eslintcache"
  }
}
```

缓存可以节省 50-90% 的 lint 时间！

### 2. 避免宽泛的 glob 模式

```typescript
// ❌ 不推荐 - 性能差
parserOptions: {
  project: ['./**/tsconfig.json'],
}

// ✅ 推荐 - 明确指定路径
parserOptions: {
  project: ['./tsconfig.json', './packages/*/tsconfig.json'],
}
```

### 3. 使用 Project Service（v8+）

Project Service 比传统的 `parserOptions.project` 更高效：

- 自动缓存类型信息
- 增量更新支持
- 与 VS Code 共享类型检查逻辑

### 4. 合理使用 ignores

将不需要 lint 的目录提前忽略：

```typescript
export const ignores = globalIgnores([
  '**/dist/**',
  '**/node_modules/**',
  '**/coverage/**',
  '**/*.min.js',
])
```

---

## 常见问题

### Q1: pnpm 严格模式下找不到依赖？

**问题**：`Cannot find package '@vue/eslint-config-typescript'`

**原因**：pnpm 默认不会提升依赖，子项目无法直接访问共享包的依赖。

**解决方案**：如果子项目直接 import 了某个包，需要在子项目中显式声明依赖：

```json
// apps/vue3-app/package.json
{
  "devDependencies": {
    "@breeze/eslint-config": "workspace:*",
    "@vue/eslint-config-typescript": "^14.6.0"
  }
}
```

### Q2: Vue 规则与 Prettier 冲突？

**问题**：`ESLintCircularFixesWarning: Circular fixes detected`

**原因**：当同时使用 ESLint Vue 插件和 Prettier 时，某些规则会产生"循环修复"问题：

- ESLint 自动修复会按一种格式修改代码
- Prettier 格式化又会改成另一种格式
- 两者相互冲突，导致代码格式反复变化

**解决方案**：关闭所有与 Prettier 冲突的 Vue 格式规则：

```typescript
{
  name: '@breeze/vue3/prettier-compat',
  rules: {
    // 这些规则与 Prettier 冲突，会导致 circular fixes
    'vue/singleline-html-element-content-newline': 'off',
    'vue/multiline-html-element-content-newline': 'off',
    'vue/html-self-closing': 'off',
    'vue/html-indent': 'off',
    'vue/max-attributes-per-line': 'off',
    'vue/first-attribute-linebreak': 'off',
    'vue/html-closing-bracket-newline': 'off',
  },
}
```

**各规则说明**：

| 规则                                      | 原本作用                           | 为何关闭                  |
| ----------------------------------------- | ---------------------------------- | ------------------------- |
| `singleline-html-element-content-newline` | 控制单行元素内容是否换行           | Prettier 有自己的换行逻辑 |
| `multiline-html-element-content-newline`  | 控制多行元素内容换行               | 同上                      |
| `html-self-closing`                       | 控制自闭合标签格式（如 `<div />`） | Prettier 根据文件类型决定 |
| `html-indent`                             | 控制 HTML 缩进                     | Prettier 统一管理所有缩进 |
| `max-attributes-per-line`                 | 限制每行属性数量                   | Prettier 自动处理属性换行 |
| `first-attribute-linebreak`               | 控制第一个属性是否换行             | Prettier 决定换行位置     |
| `html-closing-bracket-newline`            | 控制闭合括号位置                   | Prettier 管理括号位置     |

**工具职责分工**（ESLint + Prettier 集成最佳实践）：

- **ESLint**：负责代码质量和逻辑问题（如未使用的变量、类型错误等）
- **Prettier**：负责代码格式化（如缩进、换行、括号位置等）

通过这种分工，可以避免两个工具在同一问题上产生冲突。

### Q3: 配置文件报 "not found by project service"？

**问题**：根目录的 `eslint.config.js` 等文件报错。

**解决方案**：使用 `allowDefaultProject`：

```typescript
projectService: {
  allowDefaultProject: ['*.js', '*.mjs', '*.cjs'],
}
```

### Q4: 如何在特定项目禁用某些规则？

**方案**：在项目配置中覆盖规则：

```javascript
// apps/legacy-app/eslint.config.js
import { base } from '@breeze/eslint-config'

export default [
  ...base,
  {
    rules: {
      // 覆盖共享配置中的规则
      '@typescript-eslint/no-explicit-any': 'off',
    },
  },
]
```

---

## 参考资料

- [Turborepo ESLint Guide](https://turborepo.com/docs/guides/tools/eslint)
- [TypeScript ESLint - Monorepo Configuration](https://typescript-eslint.io/troubleshooting/typed-linting/monorepos/)
- [TypeScript ESLint - Project Service](https://typescript-eslint.io/blog/project-service/)
- [ESLint Flat Config](https://eslint.org/docs/latest/use/configure/configuration-files)
- [How to use ESLint v9 in a Monorepo](https://medium.com/@felipeprodev/how-to-use-eslint-v9-in-a-monorepo-with-flat-config-file-format-8ef2e06ce296)
- [2025 Guide to ESLint in Monorepos](https://junkangworld.com/blog/the-ultimate-2025-guide-to-eslint-generics-in-monorepos)
