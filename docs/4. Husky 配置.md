# Husky + lint-staged 配置

## 依赖包

| 包名          | 说明                                    |
| ------------- | --------------------------------------- |
| `husky`       | Git hooks 工具，在 commit 时触发脚本    |
| `lint-staged` | 只对暂存的文件运行 linter，提高检查速度 |

## 配置文件

### .husky/pre-commit

```bash
pnpm exec lint-staged
```

### lint-staged.config.js

```javascript
export default {
  '*.{js,ts,tsx}': ['eslint --fix'],
}
```

## 工作流程

```
git commit
    │
    ▼
pre-commit hook (husky)
    │
    ▼
lint-staged
    │
    ▼
eslint --fix (只检查暂存的文件)
    │
    ├─ 通过 → 提交成功
    └─ 失败 → 提交中止
```

## lint vs lint-staged 对比

### 区别

| 对比项   | `pnpm run lint`      | `lint-staged` (pre-commit) |
| -------- | -------------------- | -------------------------- |
| 触发时机 | 手动运行             | Git commit 时自动运行      |
| 检查范围 | **所有文件**         | **只检查暂存的文件**       |
| 修复方式 | 不自动修复（只报错） | `--fix` 自动修复           |
| 用途     | CI/CD、全局检查      | 提交前快速检查             |

### 使用场景

#### `pnpm run lint`（全局检查）

```bash
# 1. CI/CD 中检查
pnpm run lint

# 2. 检查整个项目
pnpm run lint

# 3. 查看所有 lint 问题
pnpm run lint
```

**用于：**

- CI/CD 流水线
- 代码审查前的全面检查
- 新成员加入时检查整个代码库

#### `lint-staged`（增量检查）

```bash
# Git commit 时自动运行
git commit -m "fix: bug"
# → 只检查本次修改的文件
```

**用于：**

- 提交前快速检查修改的文件
- 自动修复简单问题
- 提高开发体验

## 初始化命令

```bash
# 安装依赖
pnpm add -w -D husky lint-staged

# 初始化 husky
pnpm exec husky init

# 修改 .husky/pre-commit 文件内容为:
# pnpm exec lint-staged
```

## lint-staged 配置语法

```javascript
export default {
  // 匹配模式: [命令数组]
  '*.{js,ts,tsx}': ['eslint --fix'],

  // 多个命令按顺序执行
  '*.{js,ts}': ['eslint --fix', 'prettier --write'],

  // 不同文件类型不同命令
  '*.ts': ['eslint --fix'],
  '*.css': ['stylelint --fix'],
  '*.md': ['prettier --write'],
}
```

## 工具执行顺序的重要性

### 为什么 Prettier 必须放在最后？

在 lint-staged 配置中，**工具的执行顺序至关重要**。必须遵循"先质量，后格式"的原则。

#### ✅ 正确的顺序

```yaml
'*.{js,jsx,ts,tsx,vue}':
  - eslint --fix # 1️⃣ 先修复代码质量问题
  - prettier --write # 2️⃣ 后统一格式化

'*.{css,scss,sass,vue}':
  - stylelint --fix # 1️⃣ 先修复样式质量问题
  - prettier --write # 2️⃣ 后统一格式化
```

**原因：**

1. **Linter 的修复可能改变代码结构**

   ```javascript
   // ESLint 修复前
   const a = 1
   const b = 2

   // ESLint 修复后（拆分为多行）
   const a = 1
   const b = 2
   ```

2. **Prettier 确保最终格式一致**
   - Linter 的修复可能影响缩进、换行、行长度
   - Prettier 最后统一格式化
   - 保证提交的代码格式完全一致

#### ❌ 错误的顺序

```yaml
'*.{js,ts}':
  - prettier --write # ❌ 先格式化
  - eslint --fix # ❌ 后修复
```

**问题：**

```javascript
// 1. Prettier 先格式化好
const numbers = [1, 2, 3]

// 2. ESLint 修复（删除未使用的变量）
// → 格式可能被破坏

// 3. 最终代码格式不一致 ❌
```

### 实际案例演示

#### CSS/SCSS 示例

```scss
// 原始代码（有质量和格式问题）
.button {
  color: red;
  padding: 10px;
  display: flex;
}
```

**执行流程：**

```
1️⃣ stylelint --fix
↓
.button {
  display: flex;      // ← 属性已按顺序排列
  padding: 10px;
  color: red;
}

2️⃣ prettier --write
↓
.button {
  display: flex;      // ← 格式统一（缩进、空格）
  padding: 10px;
  color: red;
}
```

#### JavaScript 示例

```javascript
// 原始代码
const x = 1
if (x) console.log('test')
```

**执行流程：**

```
1️⃣ eslint --fix
↓
const x = 1;
if (x) console.log('test');  // ← 添加空格、分号

2️⃣ prettier --write
↓
const x = 1;
if (x) console.log("test");  // ← 统一引号风格
```

### 工具职责对比

| 阶段         | 工具                | 职责     | 示例                                           |
| ------------ | ------------------- | -------- | ---------------------------------------------- |
| **第一阶段** | ESLint<br>Stylelint | 代码质量 | 删除未使用变量<br>调整属性顺序<br>修复错误用法 |
| **第二阶段** | Prettier            | 代码格式 | 统一缩进<br>统一引号<br>统一换行               |

### 类比理解

就像装修房子：

```
1️⃣ 先检查质量（Linter）
   - 墙壁是否垂直
   - 电路是否正确
   - 水管是否漏水

2️⃣ 再统一装饰（Prettier）
   - 刷漆
   - 贴壁纸
   - 统一风格
```

**如果顺序反了：**

- 先刷好漆（Prettier）
- 后修墙（Linter）→ 漆又被破坏了 ❌

### 总结

**Prettier 必须放在最后**，原因是：

1. ✅ Linter 的修复可能改变代码结构
2. ✅ Prettier 最后统一格式，确保一致性
3. ✅ 这是业界标准实践
4. ✅ 避免工具间的冲突和重复工作

这个顺序是经过社区多年实践验证的最佳方案！

## 跳过检查

```bash
# 紧急情况下跳过 hook（不推荐）
git commit --no-verify -m "message"
```

## 官方文档

- [Husky](https://typicode.github.io/husky/)
- [lint-staged](https://github.com/lint-staged/lint-staged)
- [ESLint CLI 参数](https://eslint.org/docs/latest/use/command-line-interface)
